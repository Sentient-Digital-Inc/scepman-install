{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "OrgName": {
      "type": "string",
      "minLength": 2,
      "metadata": {
        "description": "Name of company or organization for certificate subject"
      }
    },
    "license": {
      "type": "string",
      "defaultValue": "trial",
      "metadata": {
        "description": "License Key for SCEPman"
      }
    },
    "keyVaultName": {
      "type": "string",
      "minLength": 3,
      "maxLength": 24,
      "metadata": {
        "description": "Specifies the name of the Azure Key Vault. The name of a Key Vault must be globally unique and contain only DNS-compatible characters (letters, numbers, and hyphens)."
      },
      "defaultValue": "kv-scepman-UNIQUENAME"
    },
    "storageAccountName": {
      "type": "string",
      "minLength": 3,
      "maxLength": 24,
      "metadata": {
        "description": "Choose a globally unique name for your storage account. Storage account names must be between 3 and 24 characters in length and may contain numbers and lowercase letters only."
      },
      "defaultValue": "stgscepmanUNIQUENAME"
    },
    "appServicePlanName": {
      "type": "string",
      "maxLength": 40,
      "defaultValue": "asp-scepman-UNIQUENAME"
    },
    "existingAppServicePlanID": {
      "type": "string",
      "defaultValue": "none",
      "metadata": {
        "description": "Provide the AppServicePlan ID of an existing App Service Plan. Keep default value 'none' if you want to create a new one."
      }
    },
    "appServiceName": {
      "type": "string",
      "maxLength": 60,
      "metadata": {
        "description": "The SCEPman App Service and part of the default FQDN. Therefore, it must be globally unique and contain only DNS-compatible characters."
      },
      "defaultValue": "as-scepman-UNIQUENAME"
    },
    "appServiceCertMasterName": {
      "type": "string",
      "maxLength": 60,
      "metadata": {
        "description": "The App Service for the component SCEPman Certificate Master. As it is part of the default FQDN, it must be globally unique and contain only DNS-compatible characters."
      },
      "defaultValue": "as-scepman-UNIQUENAME-cm"
    }
  },
  "variables": {
    "repositoryUrl": "https://raw.githubusercontent.com/scepman/install/master/"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "pid-a262352f-52a9-4ed9-a9ba-6a2b2478d19b-partnercenter",
      "properties": {
        "mode": "Incremental",
        "expressionEvaluationOptions": {
            "scope": "inner"
        },
        "parameters":{
            "ArtifactsLocationSCEPman": {
                "value": "[uri(variables('repositoryUrl'),'dist/Artifacts.zip')]"
            },
            "ArtifactsLocationCertMaster": {
                "value": "[uri(variables('repositoryUrl'),'dist-certmaster/CertMaster-Artifacts.zip')]"
            },
            "AppServicePlanName": {
                "value": "[parameters('appServicePlanName')]"
            },
            "AppServiceNameSCEPman": {
                "value": "[parameters('appServiceName')]"
            },
            "AppServiceNameCertMaster": {
                "value": "[parameters('appServiceCertMasterName')]"
            },
            "keyVaultName": {
                "value": "[parameters('keyVaultName')]"
            },
            "storageAccountName": {
                "value": "[parameters('storageAccountName')]"
            },
            "location": {
                "value": "[parameters('location')]"
            },
            "existingAppServicePlanID": {
                "value": "[parameters('existingAppServicePlanID')]"
            },
            "license": {
                "value": "[parameters('license')]"
            },
            "OrgName": {
                "value": "[parameters('OrgName')]"
            }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "ArtifactsLocationSCEPman": { "type" : "string" },
            "ArtifactsLocationCertMaster": { "type" : "string" },
            "AppServicePlanName": { "type" : "string" },
            "AppServiceNameSCEPman": { "type" : "string" },
            "AppServiceNameCertMaster": { "type" : "string" },
            "keyVaultName": { "type" : "string" },
            "storageAccountName": { "type" : "string" },
            "existingAppServicePlanID": { "type" : "string" },
            "location": { "type" : "string" },
            "license": { "type" : "string" },
            "OrgName": { "type" : "string" }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "DeploySCEPmanAppServices",
              "properties": {
                "mode": "Incremental",
                "templateLink": {
                  "relativePath": "nestedtemplates/appSvcDouble.json"
                },
                "parameters": {
                  "AppServicePlanName": {
                    "value": "[parameters('AppServicePlanName')]"
                  },
                  "existingAppServicePlanID": {
                    "value": "[parameters('existingAppServicePlanID')]"
                  },
                  "appServiceName": {
                    "value": "[parameters('AppServiceNameSCEPman')]"
                  },
                  "appServiceName2": {
                    "value": "[parameters('AppServiceNameCertMaster')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "SCEPmanVault",
              "dependsOn": [
                "DeploySCEPmanAppServices"
              ],
              "properties": {
                "mode": "Incremental",
                "templateLink": {
                  "relativePath": "nestedtemplates/vault.json"
                },
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "appServiceName": {
                    "value": "[parameters('appServiceNameSCEPman')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "DeploymentSCEPmanConfig",
              "dependsOn": [
                "DeploySCEPmanAppServices",
                "SCEPmanVault",
                "DeploymentStorageAccount"
              ],
              "properties": {
                "mode": "Incremental",
                "templateLink": {
                  "relativePath": "nestedtemplates/appConfig-scepman.json"
                },
                "parameters": {
                  "StorageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                  },
                  "AppServicePlanName": {
                    "value": "[parameters('AppServicePlanName')]"
                  },
                  "existingAppServicePlanID": {
                    "value": "[parameters('existingAppServicePlanID')]"
                  },
                  "appServiceName": {
                    "value": "[variables('AppServiceName')]"
                  },
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "OrgName": {
                    "value": "[parameters('OrgName')]"
                  },
                  "WebsiteArtifactsUri": {
                    "value": "[parameters('ArtifactsLocationSCEPman')]"
                  },
                  "license": {
                    "value": "[parameters('license')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "DeploymentCertMasterConfig",
              "dependsOn": [
                "DeploySCEPmanAppServices",
                "DeploymentStorageAccount"
              ],
              "properties": {
                "mode": "Incremental",
                "templateLink": {
                  "relativePath": "nestedtemplates/appConfig-certmaster.json"
                },
                "parameters": {
                  "AppServicePlanName": {
                    "value": "[parameters('AppServicePlanName')]"
                  },
                  "existingAppServicePlanID": {
                    "value": "[parameters('existingAppServicePlanID')]"
                  },
                  "appServiceName": {
                    "value": "[parameters('AppServiceNameCertMaster')]"
                  },
                  "scepmanUrl": {
                    "value": "[reference('DeploySCEPmanAppServices').outputs.scepmanURL.value]"
                  },
                  "StorageAccountTableUrl": {
                    "value": "[reference('DeploymentStorageAccount').outputs.storageAccountTableUrl.value]"
                  },
                  "WebsiteArtifactsUri": {
                    "value": "[parameters('ArtifactsLocationCertMaster')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "DeploymentStorageAccount",
              "dependsOn": [
                "DeploySCEPmanAppServices"
              ],
              "properties": {
                "mode": "Incremental",
                "templateLink": {
                  "relativePath": "nestedtemplates/stgAccount.json"
                },
                "parameters": {
                  "StorageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "appServiceName": {
                    "value": "[parameters('AppServiceNameSCEPman')]"
                  },
                  "appServiceName2": {
                    "value": "[parameters('AppServiceNameCertMaster')]"
                  }
                }
              }
            }
          ]
        }
      }
    }
  ]
}